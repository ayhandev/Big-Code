{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIG CODE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/dracula.min.css">
    <link rel="stylesheet" href="{% static 'CSS/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/lint/lint.css">
</head>
<body style="margin: 0; background-color: #1e1e1e;">
    <div class="container">
        <h1 style="margin: 0 auto 20px;">BIG CODE</h1>
        <div class="toolbar">
            <button id="run-button" ><i class="fas fa-play"></i> Run</button>
            <a href="{% url 'dom:doc' %}" style="color: white;">Documentation</a>
            <input type="file" id="file-input" multiple webkitdirectory directory style="display: none;">
        </div>
        <div id="language-selection-container">
            <div id="language-selection">Selected Language: HTML</div>
            <input type="text" id="language-search" placeholder="Search languages...">
        </div>
        <div id="language-suggestion"></div>
        <textarea id="code-editor"></textarea>
        <div id="terminal" style="margin-bottom: 100px;"></div>

            <hr width="100%">
            <strong style="text-align: center; padding: 20px;">Â© 2024 <a href="https://github.com/ayhandev/" style="color: white;">ayhandev</a></strong>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/meta.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/anyword-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/lint/css-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/lint/xml-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/lint/html-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/lint/json-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/lint/coffeescript-lint.min.js"></script>
    <script>
        var editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            lineNumbers: true,
            theme: 'dracula',
            autoCloseBrackets: true, // Auto-close brackets
            matchBrackets: true,
            lint: true, // Enable linting
            extraKeys: {"Ctrl-Space": "autocomplete"}, // Trigger autocomplete on Ctrl+Space
            hintOptions: {hint: CodeMirror.hint.anyword, html: true} // Enable hinting for any word and HTML tags
        });

        function setLanguage(language) {
            document.getElementById('language-selection').textContent = 'Selected Language: ' + language;
            editor.setOption('mode', language.toLowerCase());
            // Set code color based on language
            switch(language.toLowerCase()) {
                case 'html':
                    editor.setOption('theme', 'dracula');
                    editor.setOption('indentUnit', 2); // Set indentation unit for HTML
                    break;
                case 'python':
                    editor.setOption('theme', 'default'); // Change to Python color theme
                    editor.setOption('indentUnit', 4); // Set indentation unit for Python
                    break;
                // Add cases for other languages and their respective color themes
            }
        }
        
        // Show language suggestion
        document.getElementById('language-search').addEventListener('input', function() {
            var searchValue = this.value.toLowerCase();
            var suggestionBox = document.getElementById('language-suggestion');
            suggestionBox.innerHTML = '';

            languages.forEach(function(language) {
                if (language.toLowerCase().includes(searchValue)) {
                    var suggestionItem = document.createElement('div');
                    suggestionItem.classList.add('language-suggestion-item');
                    suggestionItem.textContent = language;
                    suggestionItem.addEventListener('click', function() {
                        setLanguage(language);
                        suggestionBox.style.display = 'none';
                    });
                    suggestionBox.appendChild(suggestionItem);
                }
            });

            if (suggestionBox.childElementCount > 0) {
                suggestionBox.style.display = 'block';
            } else {
                suggestionBox.style.display = 'none';
            }
        });

        // Hide suggestion box on clicking outside
        window.addEventListener('click', function(event) {
            var suggestionBox = document.getElementById('language-suggestion');
            if (!event.target.matches('#language-search') && !event.target.closest('#language-suggestion')) {
                suggestionBox.style.display = 'none';
            }
        });

        // Set language
        function setLanguage(language) {
            // Hide language suggestion box
            var suggestionBox = document.getElementById('language-suggestion');
            suggestionBox.style.display = 'none';

            // If the selected language is HTML, insert HTML structure
            if (language.toLowerCase() === 'html') {
                var htmlStructure = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
</head>
<body>
    
</body>
</html>`;
                editor.setValue(htmlStructure);
            } else {
                // Clear editor content for other languages
                editor.setValue('');
            }

            // Set mode and update selected language display
            editor.setOption('mode', language.toLowerCase());
            document.getElementById('language-selection').textContent = 'Selected Language: ' + language;

            // If the selected language is not HTML, set Python as default
            if (language.toLowerCase() !== 'html') {
                document.getElementById('language-search').value = '';
            }
        }

        // Initial language selection
        setLanguage('HTML');

        // Languages array
        var languages = ['Python', 'HTML'];
            
        // Run button click event
        document.getElementById('run-button').addEventListener('click', function() {
            runCode();
        });

        // Function to run code
        function runCode() {
            var code = editor.getValue();
            var language = document.getElementById('language-selection').textContent.split(' ')[2]; // Get the selected language
            if (language.toLowerCase() === 'html') {
                // Open the result in a new tab
                var newTab = window.open();
                newTab.document.write(code);
            } else {
                // Execute Python code
                fetch('/run_code/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: 'code=' + encodeURIComponent(code) + '&language=' + encodeURIComponent(language)
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('terminal').innerText = data.output;
                });
            }
        }
        
    </script>
</body>
</html>
